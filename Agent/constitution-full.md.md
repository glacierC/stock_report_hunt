# .claude — 单人 Agentic Coding 工作惯例（非程序员友好版）
# Last Updated: 2026-01-27
# Version: 2.0.0
#
# 设计理念：
# - 你不需要懂代码，但需要能验证"AI 是否做了你想要的事"
# - 文档是防止 AI 幻觉和漂移的唯一武器
# - 保持最小纪律，避免文档通胀

============================================================
📌 核心原则（永远记住这 3 条）
============================================================
1. **单一事实源（SSOT）**：roadmap.md 是唯一的需求清单，其他文档都从它派生
2. **可验证交付**：每次 AI 说"完成了"，你必须能用简单步骤验证（不需要看代码）
3. **文档跟着代码走**：代码改了，文档必须同步更新（否则下次 AI 会基于错误信息继续）

============================================================
🚀 启动流程（每次对话开始时）
============================================================
## AI 必须先做的事：
1. 读取以下文件（按顺序）：
   - `roadmap.md` → 了解当前要做什么
   - `agent/constitution.md` → 了解项目规则和约束
   - `stories/` 目录下状态为 `Doing` 的 Story → 了解进行中的任务

2. 输出启动回显（必须包含）：
```
   📖 已读取：
   - roadmap.md (v0.3, 当前优先级: xxx)
   - stories/S0005-xxx.md (状态: Doing)
   
   🎯 本次目标：
   [用一句话说明要做什么]
   
   📂 预计涉及的文件：
   - 代码：src/xxx.js, api/xxx.py
   - 文档：docs/features/xxx/
```

## 如果缺少这些文件：
执行 Bootstrap（见最后一节），先建立最小骨架。

============================================================
📋 需求管理（Roadmap → Story）
============================================================
## roadmap.md 的结构：
```markdown
# Roadmap

## 当前版本：v0.3
发布目标：2026-02-15

## 🔥 Top 3 优先级（只关注这 3 个）
1. [S0005] 用户登录功能 ← 当前在做
2. [待拆分] 数据导出功能
3. [待拆分] 邮件通知

## 📦 已完成（v0.1 - v0.2）
- [S0001] 项目初始化
- [S0002] 基础页面布局
- ...

## 🗑️ 暂不考虑（Backlog）
- 多语言支持
- ...
```

## Story 的生命周期：
```
模糊需求 → roadmap 排优先级 → 拆分成 Story → 实现 → 验收 → 回写 roadmap
```

**重要**：roadmap 里只写"要做什么"，具体"怎么做"写在 Story 里。

============================================================
📝 Story 规范（单次交付单位）
============================================================
## 何时创建 Story：
- 当 roadmap 里的某个需求要开始做了
- 当发现了需要修复的 Bug

## Story 文件命名：
- 功能：`stories/S0001-user-login.md`
- Bug：`stories/B0001-login-button-not-working.md`

## Story 必须包含的内容（精简版）：

### 1. 目标（1 句话）
**例**：实现用户可以通过邮箱和密码登录系统

### 2. 验收标准（你能自己测试的步骤）
**重要**：这部分必须是非程序员能执行的步骤
```
- [ ] 打开 http://localhost:3000/login
- [ ] 输入邮箱 test@example.com，密码 123456
- [ ] 点击"登录"按钮
- [ ] 应该跳转到 /dashboard 页面，右上角显示"欢迎，Test User"
```

### 3. 涉及的文件（AI 填写）
```
代码：
- src/pages/Login.jsx
- src/api/auth.js

文档：
- docs/features/auth/overview.md (功能说明)
- docs/features/auth/test-guide.md (测试指引)
```

### 4. 状态跟踪
```
状态：Todo / Doing / Blocked / Done
开始时间：2026-01-27
完成时间：(待填)
```

### 5. 验收记录（完成后必填）
```
验收人：[你的名字]
验收时间：2026-01-28
验收结果：✅ 通过 / ❌ 失败
失败原因（如有）：xxx
```

## Story 模板（直接复制使用）：
见文末附录 A。

============================================================
🔄 标准工作流（每个 Story 的完整流程）
============================================================
## 阶段 1：需求确认
👤 **你**：
- 在 roadmap 里把某个需求标记为 Top 1
- （可选）补充说明或限制条件

🤖 **AI**：
- 读取 roadmap
- 创建新的 Story 文件（或更新现有 Story）
- 在 Story 里写清楚"验收标准"
- **停下来，等你确认**

👤 **你**：
- 检查验收标准是否是你想要的
- 确认或修改

---

## 阶段 2：实现
🤖 **AI**：
- 按 Story 实现功能
- 过程中如果遇到不确定的地方：
  - 写在 Story 的 `⚠️ 假设与风险` 区域
  - 询问你的意见（不要自己瞎猜）

---

## 阶段 3：文档同步
🤖 **AI** 必须做：
- 在 `docs/features/<功能名>/` 下创建或更新：
  - `overview.md` → 这个功能是干什么的，给谁用的
  - `test-guide.md` → 如何测试这个功能（非技术步骤）
- 如果有 API，创建 `api.md` 列出所有接口
- 如果有界面，创建 `ui-flow.md` 说明操作流程

**重要**：文档必须用你能看懂的语言写，不要全是技术术语。

---

## 阶段 4：验收
🤖 **AI**：
- 把 Story 里的"验收标准"拷贝出来
- 告诉你："请按以下步骤测试，然后告诉我结果"

👤 **你**：
- 按步骤操作
- 把结果告诉 AI（通过 / 失败 / 部分通过）

如果失败：
- AI 创建 Bug Story（B0001-xxx.md）
- 修复后重新验收

如果通过：
- 进入阶段 5

---

## 阶段 5：回写（AI 必须做）
🤖 **AI** 必须更新以下文件：
1. **Story 文件**：
   - 状态改为 `Done`
   - 填写完成时间
   - 记录验收结果

2. **roadmap.md**：
   - 把这个 Story 从 Top 3 移到"已完成"区域
   - 下一个需求自动顶上来

3. **changelog.md**：
   - 记录这次的变更（面向发布说明）
```markdown
   ## [v0.3] - 2026-01-28
   ### Added
   - 用户登录功能 (S0005)
```

4. **给你一个总结**：
```
   ✅ S0005 已完成
   📄 更新的文档：docs/features/auth/overview.md, docs/features/auth/test-guide.md
   📝 更新的代码：src/pages/Login.jsx, src/api/auth.js
   🔗 下一步建议：开始 S0006（数据导出功能）？
```

============================================================
🐛 Bug 处理（快速通道）
============================================================
## 何时创建 Bug Story：
- 验收失败时
- 使用过程中发现问题时

## Bug Story 的精简格式：
```markdown
# B0001 - 登录按钮点击无反应

## 现象
点击登录按钮后，没有任何反应，也没有跳转

## 复现步骤
1. 打开 http://localhost:3000/login
2. 输入任意邮箱和密码
3. 点击登录按钮
→ 预期：跳转到 /dashboard
→ 实际：页面无变化

## 关联 Story
S0005 - 用户登录功能

## 修复后的验收步骤
（同 S0005 的验收标准）

## 状态
Doing
```

## Bug 修复后必须做：
- 在原 Story（S0005）的文档里补充"已知问题"或"边界说明"
- 避免同样的问题再次出现

============================================================
📚 文档规则（最小必要集合）
============================================================
## 每个功能必须有的文档：
```
docs/features/<功能名>/
├── overview.md       (必须) 功能是什么，给谁用，有什么限制
├── test-guide.md     (必须) 如何验证功能正常（非技术步骤）
├── api.md            (可选) 如果有 API 接口
├── ui-flow.md        (可选) 如果有界面交互
└── troubleshooting.md (可选) 常见问题与解决
```

## 文档的生命周期：
- **创建时机**：Story 实现完成后
- **更新时机**：
  - 代码改了功能行为 → 必须更新
  - 发现文档写错了 → 必须更新
  - 增加了新的边界或限制 → 必须补充
- **健康检查**：
  - 每个文档头部有 `Last Updated: YYYY-MM-DD`
  - AI 每次修改代码后，必须检查对应文档是否需要更新

## 文档的语言风格：
- ✅ 用"你"称呼用户（例如："你可以点击按钮来..."）
- ✅ 用操作步骤，不要用技术术语（除非必要）
- ❌ 不要写"该模块通过调用 API 实现..."（这是给程序员看的）

============================================================
⚙️ 技术决策记录（ADR）
============================================================
## 何时需要 ADR：
只在以下情况需要：
- 选择了关键的技术框架（例如：React vs Vue）
- 选择了数据存储方式（例如：MySQL vs MongoDB）
- 做了影响后续扩展的架构决定

## ADR 精简格式：
```markdown
# ADR-0001 - 使用 React 作为前端框架

## 背景
需要构建一个交互式的用户界面

## 决策
使用 React 18

## 原因
- AI 对 React 更熟悉，减少出错
- 生态成熟，遇到问题容易找到解决方案

## 代价
- 学习曲线相对陡峭（但我不需要学，AI 会处理）

## 日期
2026-01-27
```

## 注意：
- 不要为小的技术选择写 ADR（例如用哪个 CSS 库）
- ADR 一旦写了就不删除，如果决策改变了，写新的 ADR 并标注"替代 ADR-0001"

============================================================
🛡️ 防止 AI 幻觉和漂移的检查清单
============================================================
## 你要定期检查的事情：
### 每个 Story 完成后：
- [ ] Story 状态是否改为 `Done`？
- [ ] changelog.md 是否更新？
- [ ] roadmap.md 是否移动了该 Story？
- [ ] 对应的文档是否创建/更新？

### 每周一次：
- [ ] roadmap 的 Top 3 是否还是你想要的优先级？
- [ ] 有没有 Story 状态一直是 `Doing` 超过 3 天？（可能卡住了）
- [ ] docs/ 目录下的文档，Last Updated 日期是否合理？

### AI 说"完成"时，必须问的问题：
1. "给我看验收步骤"
2. "哪些文档更新了？给我文件路径"
3. "roadmap 更新了吗？"

如果 AI 没有主动提供这些信息，直接拒绝接受"完成"。

============================================================
🎯 简化模式（适合快速原型或探索阶段）
============================================================
如果你只是想快速试试想法，可以暂时简化：

## Lite 模式规则：
- 不需要创建 Story 文件
- roadmap 可以简化成 TODO list
- 但 **必须保留**：
  - roadmap.md（记录要做什么）
  - changelog.md（记录做了什么）
  - docs/features/*/overview.md（至少有功能说明）

## 何时切换回标准模式：
- 当功能开始变复杂（> 5 个主要功能）
- 当你发现 AI 开始"忘记"之前做过的事
- 当你需要把项目交给别人（或未来的 AI）

============================================================
🚨 紧急情况处理
============================================================
## 如果 AI 说"我不记得之前做过什么"：
1. 让 AI 重新读取 roadmap.md 和所有 Story 文件
2. 让 AI 输出"项目当前状态总结"
3. 如果还是不行，检查文档是否有冲突或过期

## 如果验收失败：
1. 创建 Bug Story（B000X-xxx.md）
2. 不要让 AI 直接改，先让它分析原因
3. 原因确认后再修复

## 如果文档和代码不一致：
1. **永远以代码的实际行为为准**
2. 让 AI 更新文档
3. 在 Story 里记录"发现文档漂移，已修正"

============================================================
📦 Bootstrap（项目初始化）
============================================================
如果你是第一次使用这套流程，或者项目缺少必要文件：

## 让 AI 执行以下步骤：
1. 创建目录结构：
```
   项目根目录/
   ├── .claude              (本文件)
   ├── roadmap.md
   ├── changelog.md
   ├── agent/
   │   └── constitution.md
   ├── stories/
   ├── docs/
   │   ├── features/
   │   └── bugs/
   └── decisions/
```

2. 初始化 roadmap.md：
```markdown
   # Roadmap
   
   ## 当前版本：v0.1
   项目刚启动
   
   ## 🔥 Top 3 优先级
   1. [待拆分] <你的第一个需求>
   2. (待定)
   3. (待定)
```

3. 初始化 constitution.md：
```markdown
   # Agent Constitution
   
   ## 项目基本信息
   - 项目名称：<填写>
   - 主要目的：<填写>
   - 技术栈：<AI 会补充>
   
   ## 核心约束
   - 使用的语言：<Python/JavaScript/等>
   - 不允许使用的库：<如有限制>
   - 必须遵守的规范：<如有>
```

4. 输出启动确认：
```
   ✅ 项目骨架已创建
   📋 下一步：请告诉我你想先做什么功能，我会创建第一个 Story
```

============================================================
📎 附录 A：Story 模板
============================================================
```markdown
# S0001 - <一句话标题>

## 1. 目标
<用一句话说明要实现什么>

## 2. 背景（可选）
<为什么要做这个？解决什么问题？>

## 3. 验收标准（必须可由非程序员执行）
- [ ] 步骤 1：打开 xxx 页面
- [ ] 步骤 2：点击 xxx 按钮
- [ ] 步骤 3：应该看到 xxx 结果

## 4. 范围
### 包含：
- xxx
### 不包含：
- xxx

## 5. 技术方案（AI 填写）
- 涉及的代码文件：
- 涉及的文档：
- 关键技术点：

## 6. 假设与风险（AI 填写）
- 假设：
- 风险：
- 不确定的地方：

## 7. 验收记录
- 验收人：
- 验收时间：
- 验收结果：✅ / ❌
- 备注：

## 8. 状态
- 当前状态：Todo / Doing / Blocked / Done
- 开始时间：
- 完成时间：
- Blocker（如有）：
```

============================================================
📎 附录 B：Bug Story 模板
============================================================
```markdown
# B0001 - <Bug 简短描述>

## 现象
<发生了什么>

## 复现步骤
1. 
2. 
3. 
→ 预期：
→ 实际：

## 严重程度
- [ ] P0 - 阻塞使用
- [ ] P1 - 影响体验
- [ ] P2 - 小问题

## 关联 Story
S0001 - xxx

## 根因（AI 填写）
<为什么会出现这个问题>

## 修复方案（AI 填写）
<打算怎么修>

## 验收步骤
（同复现步骤，但结果应该符合预期）

## 防止再次出现的措施
- 补充到 Story 文档的哪里：
- 补充的测试用例：

## 状态
- 当前状态：Todo / Doing / Done
- 修复时间：
```

============================================================
✅ 使用检查清单（给 AI 的）
============================================================
## 每次对话开始时：
- [ ] 我是否读取了 roadmap.md？
- [ ] 我是否读取了进行中的 Story？
- [ ] 我是否输出了启动回显？

## 开始实现前：
- [ ] Story 的验收标准是否清晰？
- [ ] 我是否向用户确认了验收标准？
- [ ] 我是否列出了假设与不确定的地方？

## 实现过程中：
- [ ] 我是否在改代码前读取了相关文档？
- [ ] 我是否避免了无谓的重构？
- [ ] 遇到不确定的地方，我是否询问了用户？

## 完成后：
- [ ] 我是否创建/更新了 docs/features/*/overview.md？
- [ ] 我是否创建/更新了 docs/features/*/test-guide.md？
- [ ] 我是否更新了 Story 状态和完成时间？
- [ ] 我是否更新了 roadmap.md？
- [ ] 我是否更新了 changelog.md？
- [ ] 我是否给用户提供了清晰的验收步骤？

# ============================================================
# End of .claude
# ============================================================